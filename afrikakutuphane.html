<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Militan Atlas - K√ºt√ºphane</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f172a;
            color: #f8fafc;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #334155;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(139, 92, 246, 0.3);
        }

        .btn-secondary {
            background: rgba(139, 92, 246, 0.1);
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(139, 92, 246, 0.2);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .search-bar {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .search-bar input {
            flex: 1;
            background: none;
            border: none;
            color: #f8fafc;
            font-size: 1rem;
            outline: none;
        }

        .search-bar input::placeholder {
            color: #64748b;
        }

        .filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            color: #a78bfa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .filter-btn.active {
            background: rgba(139, 92, 246, 0.3);
            border-color: rgba(139, 92, 246, 0.6);
        }

        .filter-btn:hover {
            background: rgba(139, 92, 246, 0.2);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: #4ade80;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #94a3b8;
        }

        .country-section {
            margin-bottom: 2rem;
        }

        .country-header {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px 12px 0 0;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .country-header:hover {
            background: #2d3748;
        }

        .country-name {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .country-count {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .groups-list {
            background: #1a2332;
            border: 1px solid #334155;
            border-top: none;
            border-radius: 0 0 12px 12px;
            padding: 0;
            display: none;
        }

        .groups-list.active {
            display: block;
        }

        .group-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #334155;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .group-item:last-child {
            border-bottom: none;
        }

        .group-item:hover {
            background: rgba(139, 92, 246, 0.1);
        }

        .group-name {
            font-weight: 600;
            color: #f8fafc;
        }

        .group-category {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .category-cihat {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .category-ayrilik {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
        }

        .tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 13px;
            pointer-events: none;
            z-index: 2000;
            display: none;
            border: 1px solid rgba(74, 222, 128, 0.3);
            white-space: nowrap;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
        }

        .category-diger {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        /* Modal (same as index.html) */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1e293b;
            border-radius: 20px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #334155;
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .close-btn {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 2rem;
            cursor: pointer;
            line-height: 1;
        }

        .close-btn:hover {
            color: #f8fafc;
        }

        .modal-body {
            padding: 2rem;
        }

        .detail-section {
            margin-bottom: 1.5rem;
        }

        .detail-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #4ade80;
            margin-bottom: 0.5rem;
        }

        .detail-text {
            color: #cbd5e1;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .interactive-link {
            color: #eab308;
            font-weight: bold;
            text-decoration: underline;
            cursor: pointer;
            transition: color 0.2s;
        }

        .interactive-link:hover {
            color: #4ade80;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">üìö Mƒ∞Lƒ∞TAN ATLAS - AFRƒ∞KA K√úT√úPHANESƒ∞</div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="window.location.href='index.html'">‚Üê Ana Sayfa</button>
                <button class="btn btn-primary"
                    onclick="window.location.href='afrika.html' + window.location.search">üó∫Ô∏è
                    AFRƒ∞KA ATLASINA G√ñZAT</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="search-bar">
            <svg style="width:20px;height:20px;color:#64748b;" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" id="search-input" placeholder="Grup veya √ºlke ara...">
        </div>

        <div class="filters">
            <button class="filter-btn active" onclick="setFilter('all')">T√ºm√º</button>
            <button class="filter-btn" onclick="setFilter('cihat')">Cihat√ßƒ±</button>
            <button class="filter-btn" onclick="setFilter('ayrilik')">Ayrƒ±lƒ±k√ßƒ±</button>
            <button class="filter-btn" onclick="setFilter('diger')">Diƒüer</button>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="total-groups">0</div>
                <div class="stat-label">Toplam √ñrg√ºt</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-countries">0</div>
                <div class="stat-label">√úlke</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="cihat-count">0</div>
                <div class="stat-label">Cihat√ßƒ±</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="ayrilik-count">0</div>
                <div class="stat-label">Ayrƒ±lƒ±k√ßƒ±</div>
            </div>
            <!-- Grafiƒüin sƒ±ƒüacaƒüƒ± yeni kart -->
            <div class="stat-card"
                style="grid-column: span 2; display: flex; align-items: center; justify-content: center; min-height: 200px;">
                <canvas id="category-chart"></canvas>
            </div>
        </div>

        <div id="countries-container"></div>
    </div>

    <!-- Group Detail Modal -->
    <div id="group-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-group-name">√ñrg√ºt ƒ∞smi</h2>
                <div style="display:flex; gap:10px; align-items:center; margin-left:auto;">
                    <button class="btn btn-primary" onclick="printGroupReport()"
                        style="font-size:0.8rem; padding:0.5rem 1rem;"><i class="fas fa-print"></i> Rapor Al</button>
                    <button class="btn-close" onclick="closeAllModals()">√ó</button>
                </div>
            </div>
            <div class="modal-body">
                <div class="filters" style="margin-bottom:1rem;">
                    <button class="filter-btn active" data-tab="temel"
                        onclick="showTabContent('temel')">KATEGORƒ∞</button>
                    <button class="filter-btn" data-tab="durum" onclick="showTabContent('durum')">DURUM</button>
                    <button class="filter-btn" data-tab="detay" onclick="showTabContent('detay')">DETAY G√ñR</button>
                </div>
                <div id="tab-content" style="padding:1rem; text-align:center; min-height:100px;"></div>
            </div>
        </div>
    </div>

    <!-- Long Detail Modal -->
    <div id="long-detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="btn btn-secondary" onclick="closeLongModal()">‚Üê Geri</button>
                <h2 class="modal-title">Detaylƒ± Bilgi</h2>
                <button class="close-btn" onclick="closeAllModals()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="filters" style="margin-bottom:1rem; flex-wrap:wrap;">
                    <button class="filter-btn active" onclick="showLongTabContent('olusum')">Olu≈üumu</button>
                    <button class="filter-btn" onclick="showLongTabContent('amac')">Ama√ß</button>
                    <button class="filter-btn" onclick="showLongTabContent('yonetim')">Y√∂netim</button>
                    <button class="filter-btn" onclick="showLongTabContent('metot')">Taktikler</button>
                    <button class="filter-btn" onclick="showLongTabContent('eylem')">Eylemler</button>
                    <button class="filter-btn" onclick="showLongTabContent('finans')">Kaynak</button>
                    <button class="filter-btn" onclick="showLongTabContent('iliski')">ƒ∞li≈ükiler</button>
                    <button class="filter-btn" onclick="showLongTabContent('diger')">Diƒüer</button>
                    <button class="filter-btn" onclick="showLongTabContent('kaynak')">Kaynak√ßa</button>
                </div>
                <div id="long-detail-body" style="padding:1rem;"></div>
            </div>
        </div>
    </div>

    <script>
        let countryData = {};
        let currentFilter = 'all';
        let currentRegion = null;
        let currentCountryId = null;
        let currentGroupIdx = null;

        // Region mapping
        const regionMap = {
            'africa': ['DZ', 'EG', 'LY', 'MA', 'TN', 'SD', 'SO', 'KE', 'TZ', 'UG', 'ZA', 'ZW', 'ZM', 'NG', 'ET', 'GH', 'CI', 'SN', 'ML', 'BF', 'NE', 'TD', 'CF', 'CM', 'GA', 'CG', 'CD', 'AO', 'MZ', 'MW', 'ZM', 'BW', 'NA', 'LS', 'SZ', 'MG', 'MU', 'SC', 'KM', 'DJ', 'ER', 'SS', 'RW', 'BI', 'TG', 'BJ', 'GW', 'SL', 'LR', 'GM', 'GN', 'GQ', 'ST'],
            'middle-east': ['TR', 'SY', 'IQ', 'IR', 'SA', 'YE', 'AE', 'IL', 'JO', 'LB', 'KW', 'QA', 'BH', 'OM', 'PS'],
            'asia': ['AF', 'PK', 'IN', 'BD', 'MM', 'TH', 'ID', 'MY', 'PH', 'CN', 'JP', 'KR', 'KP', 'VN', 'LA', 'KH', 'SG', 'BN', 'TL', 'MN', 'NP', 'BT', 'LK', 'MV'],
            'europe': ['GB', 'FR', 'DE', 'ES', 'IT', 'RU', 'UA', 'PL', 'RO', 'NL', 'BE', 'GR', 'PT', 'CZ', 'HU', 'SE', 'AT', 'BY', 'RS', 'CH', 'BG', 'DK', 'FI', 'SK', 'NO', 'IE', 'HR', 'BA', 'GE', 'LT', 'SI', 'LV', 'EE', 'MK', 'AL', 'MD', 'MT', 'LU', 'ME', 'CY', 'AD', 'LI', 'MC', 'SM', 'VA', 'IS'],
            'americas': ['US', 'CA', 'MX', 'BR', 'AR', 'CO', 'PE', 'VE', 'CL', 'EC', 'BO', 'PY', 'UY', 'GY', 'SR', 'GF', 'CR', 'PA', 'CU', 'DO', 'HT', 'JM', 'TT', 'BS', 'BB', 'LC', 'GD', 'VC', 'AG', 'DM', 'KN', 'NI', 'HN', 'SV', 'GT', 'BZ'],
            'oceania': ['AU', 'NZ', 'PG', 'FJ', 'SB', 'VU', 'NC', 'PF', 'WS', 'KI', 'TO', 'FM', 'PW', 'MH', 'NR', 'TV']
        };

        // Get region from URL
        const urlParams = new URLSearchParams(window.location.search);
        currentRegion = urlParams.get('region');

        // Load data
        function loadData() {
            fetch('trdata.json?t=' + Date.now())
                .then(response => {
                    if (!response.ok) throw new Error("JSON dosyasƒ± bulunamadƒ±.");
                    return response.json();
                })
                .then(data => {
                    countryData = data;
                    console.log("Veri trdata.json dosyasƒ±ndan y√ºklendi.");
                    processLoadedData();
                })
                .catch(err => {
                    console.warn("trdata.json y√ºklenemedi, LocalStorage deneniyor...", err);
                    const s = localStorage.getItem('militan_db_v2');
                    if (s) {
                        try {
                            countryData = JSON.parse(s);
                            processLoadedData();
                        } catch (e) {
                            showError(err.message);
                        }
                    } else {
                        showError(err.message);
                    }
                });
        }

        function processLoadedData() {
            // Filter by region if specified
            if (currentRegion && regionMap[currentRegion]) {
                const allowedCountries = regionMap[currentRegion];
                const filtered = {};
                Object.keys(countryData).forEach(id => {
                    if (allowedCountries.includes(id)) {
                        filtered[id] = countryData[id];
                    }
                });
                countryData = filtered;
            }
            updateStats();
            renderCountries();
        }

        function showError(msg) {
            const container = document.getElementById('countries-container');
            container.innerHTML = `<div style="text-align:center; padding:2rem; color:#ef4444;">
                <h3>Veri Y√ºklenemedi</h3>
                <p>${msg}</p>
            </div>`;
        }

        let globalChart = null;
        function updateStats() {
            let uniqueNames = new Set();
            let cihatSet = new Set();
            let ayrilikSet = new Set();
            let digerSet = new Set();

            Object.values(countryData).forEach(c => {
                if (c.groups) {
                    c.groups.forEach(g => {
                        const name = g.name_tr.trim();
                        uniqueNames.add(name);
                        const cat = g.kategori || "Diƒüer";
                        if (cat === "Cihat√ßƒ±") cihatSet.add(name);
                        else if (cat === "Ayrƒ±lƒ±k√ßƒ±") ayrilikSet.add(name);
                        else digerSet.add(name);
                    });
                }
            });

            document.getElementById('total-groups').textContent = uniqueNames.size;
            document.getElementById('total-countries').textContent = Object.keys(countryData).length;
            document.getElementById('cihat-count').textContent = cihatSet.size;
            document.getElementById('ayrilik-count').textContent = ayrilikSet.size;

            initChart(cihatSet.size, ayrilikSet.size, digerSet.size);
        }

        function initChart(cihat, ayrilik, diger) {
            const ctx = document.getElementById('category-chart').getContext('2d');
            if (globalChart) globalChart.destroy();

            globalChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Cihat√ßƒ±', 'Ayrƒ±lƒ±k√ßƒ±', 'Diƒüer'],
                    datasets: [{
                        data: [cihat, ayrilik, diger],
                        backgroundColor: ['#ef4444', '#eab308', '#3b82f6'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#94a3b8', font: { size: 12, weight: 'bold' } }
                        }
                    }
                }
            });
        }

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderCountries();
        }

        function renderCountries() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
            const container = document.getElementById('countries-container');
            container.innerHTML = '';

            let groupMap = {}; // name -> { group, cid, gidx, countries: [] }

            Object.keys(countryData).forEach(id => {
                const country = countryData[id];
                if (country.groups) {
                    country.groups.forEach((g, idx) => {
                        const name = g.name_tr;
                        const cat = g.kategori || "Diƒüer";
                        // Filter check
                        const matchesFilter = currentFilter === 'all' ||
                            (currentFilter === 'cihat' && cat === 'Cihat√ßƒ±') ||
                            (currentFilter === 'ayrilik' && cat === 'Ayrƒ±lƒ±k√ßƒ±') ||
                            (currentFilter === 'diger' && cat !== 'Cihat√ßƒ±' && cat !== 'Ayrƒ±lƒ±k√ßƒ±');

                        const matchesSearch = !searchTerm ||
                            (name && name.toLowerCase().includes(searchTerm)) ||
                            country.name_tr.toLowerCase().includes(searchTerm);

                        if (matchesFilter && matchesSearch) {
                            if (!groupMap[name]) {
                                groupMap[name] = {
                                    group: g,
                                    cid: id,
                                    gidx: idx,
                                    countries: [country.name_tr]
                                };
                            } else {
                                if (!groupMap[name].countries.includes(country.name_tr)) {
                                    groupMap[name].countries.push(country.name_tr);
                                }
                            }
                        }
                    });
                }
            });

            const sortedGroups = Object.values(groupMap).sort((a, b) => a.group.name_tr.localeCompare(b.group.name_tr));

            if (sortedGroups.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding:2rem; color:#666;">Hi√ßbir √∂rg√ºt bulunamadƒ±.</p>';
                return;
            }

            // Global Liste Ba≈ülƒ±ƒüƒ±
            const header = document.createElement('div');
            header.style.textAlign = 'center';
            header.style.padding = '1rem';
            header.style.color = '#94a3b8';
            header.style.fontSize = '0.9rem';
            header.style.borderBottom = '1px solid #1e293b';
            header.style.marginBottom = '1.5rem';
            header.textContent = `Toplam ${sortedGroups.length} benzersiz √∂rg√ºt listeleniyor.`;
            container.appendChild(header);

            sortedGroups.forEach(m => {
                const g = m.group;
                const cat = g.kategori || "Diƒüer";
                const catClass = cat === 'Cihat√ßƒ±' ? 'category-cihat' :
                    cat === 'Ayrƒ±lƒ±k√ßƒ±' ? 'category-ayrilik' : 'category-diger';

                const item = document.createElement('div');
                item.className = 'group-item';
                item.style.display = 'flex';
                item.style.alignItems = 'center';
                item.style.padding = '1.2rem';
                item.style.background = 'rgba(30, 41, 59, 0.3)';
                item.style.border = '1px solid #1e293b';
                item.style.borderRadius = '12px';
                item.style.marginBottom = '10px';
                item.style.cursor = 'pointer';
                item.style.transition = 'all 0.2s';

                item.onmouseover = () => item.style.background = 'rgba(30, 41, 59, 0.6)';
                item.onmouseout = () => item.style.background = 'rgba(30, 41, 59, 0.3)';

                item.onclick = () => openGroupModal(m.cid, m.gidx);

                item.innerHTML = `
                    <div style="flex:1;">
                        <div class="group-name" style="font-size:1.1rem; font-weight:700; color:#f1f5f9;">${g.name_tr}</div>
                        <div style="font-size:0.85rem; color:#64748b; margin-top:5px; display:flex; align-items:center; gap:5px;">
                            <i class="fas fa-globe-africa"></i> ${m.countries.join(", ")}
                        </div>
                    </div>
                    <div class="group-category ${catClass}" style="margin-left:15px; min-width:100px; text-align:center;">${cat}</div>
                `;
                container.appendChild(item);
            });
        }

        function toggleCountry(id) {
            const list = document.getElementById(`groups-${id}`);
            list.classList.toggle('active');
        }

        function openGroupModal(countryId, groupIdx) {
            currentCountryId = countryId;
            currentGroupIdx = groupIdx;
            const group = countryData[countryId].groups[groupIdx];
            document.getElementById('modal-group-name').textContent = group.name_tr;

            // Varsayƒ±lan olarak "Kategori" sekmesini g√∂ster
            showTabContent('temel');

            document.getElementById('group-modal').classList.add('active');
        }

        function showTabContent(tab) {
            // Tab butonlarƒ±nƒ± g√ºncelle
            document.querySelectorAll('#group-modal .filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-tab') === tab) btn.classList.add('active');
            });

            const group = countryData[currentCountryId].groups[currentGroupIdx];
            const details = group.details || {};
            const content = document.getElementById('tab-content');

            if (tab === 'temel') {
                const cat = group.kategori || 'Diƒüer';
                const catClass = cat === 'Cihat√ßƒ±' ? 'category-cihat' :
                    cat === 'Ayrƒ±lƒ±k√ßƒ±' ? 'category-ayrilik' : 'category-diger';
                content.innerHTML = `
                    <div style="display:inline-block; padding:1rem 2rem; border-radius:12px;" class="${catClass}">
                        <div style="font-size:2rem; font-weight:800;">${cat}</div>
                    </div>
                `;
            } else if (tab === 'durum') {
                const status = group.grup_durumu || (details && details.grup_durumu) || 'Bilgi yok';
                content.innerHTML = `
                    <div style="text-align:left; max-width:600px; margin:0 auto;">
                        <div class="detail-section">
                            <div class="detail-title">Grup Durumu</div>
                            <div class="detail-text">${status}</div>
                        </div>
                    </div>
                `;
            } else if (tab === 'detay') {
                content.innerHTML = `
                    <button class="btn btn-primary" onclick="openLongModal()" style="font-size:1.2rem; padding:1rem 2rem;">
                        üìñ T√ºm Detaylarƒ± G√∂r√ºnt√ºle
                    </button>
                `;
            }
        }

        function openLongModal() {
            document.getElementById('long-detail-modal').classList.add('active');
            showLongTabContent('olusum');
        }

        function showLongTabContent(section) {
            // Tab butonlarƒ±nƒ± g√ºncelle
            document.querySelectorAll('#long-detail-modal .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // Find the button that triggered the event or set 'olusum' as active if called directly
            const targetButton = event ? event.target : document.querySelector('#long-detail-modal .filter-btn[onclick*="showLongTabContent(\'' + section + '\')"]');
            if (targetButton) {
                targetButton.classList.add('active');
            }

            const group = countryData[currentCountryId].groups[currentGroupIdx];
            const details = group.details || {};
            const body = document.getElementById('long-detail-body');

            const sectionMap = {
                'olusum': { title: 'Olu≈üum S√ºreci', key: 'olusum_sureci' },
                'amac': { title: 'Nihai Hedef', key: 'nihai_hedef' },
                'yonetim': { title: 'Y√∂netim ve Yapƒ±lanma', key: 'yonetim_yapisi' },
                'metot': { title: 'Eylem Taktikleri', key: 'eylem_metotlari' },
                'eylem': { title: 'Ger√ßekle≈ütirilen Eylemler', key: 'onemli_eylemler' },
                'finans': { title: 'Kaynak Temini', key: 'finansman_kaynaklari' },
                'iliski': { title: 'ƒ∞li≈ükiler', key: 'grup_iliskileri' },
                'diger': { title: 'Diƒüer Bilgiler', key: 'diger_bilgiler' },
                'kaynak': { title: 'Kaynak√ßa', key: 'kaynakca' }
            };

            const info = sectionMap[section];
            if (info) {
                let contentText = details[info.key] || 'Bilgi yok';
                // T√ºm metin alanlarƒ±nda linkleme yapalƒ±m
                contentText = processTextLinks(contentText);

                body.innerHTML = `
                    <div class="detail-section">
                        <div class="detail-title">${info.title}</div>
                        <div class="detail-text">${contentText}</div>
                    </div>
                `;
            }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // METƒ∞N ƒ∞√áƒ∞ Lƒ∞NKLEME (√ñRG√úT ƒ∞Sƒ∞MLERƒ∞)
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function processTextLinks(text) {
            if (!text || text === 'Bilgi yok') return text;

            function escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            const allGroupNames = new Set();
            Object.values(countryData).forEach(c => {
                if (c.groups) c.groups.forEach(g => {
                    if (g.name_tr) allGroupNames.add(g.name_tr);
                });
            });

            const sortedNames = Array.from(allGroupNames).sort((a, b) => b.length - a.length);

            let processedText = text;
            let placeholders = [];
            const currentGroupName = countryData[currentCountryId].groups[currentGroupIdx].name_tr;

            sortedNames.forEach(name => {
                if (name === currentGroupName) return;

                const escapedName = escapeRegExp(name);
                const regex = new RegExp(`(${escapedName})`, 'gi');
                const safeName = name.replace(/'/g, "\\'");

                processedText = processedText.replace(regex, (match) => {
                    const p = `##LINK_${placeholders.length}##`;
                    placeholders.push(`<span class="interactive-link" onclick="goToGroupByName('${safeName}')">${match}</span>`);
                    return p;
                });
            });

            placeholders.forEach((html, i) => {
                processedText = processedText.replace(`##LINK_${i}##`, html);
            });

            return processedText;
        }

        function goToGroupByName(name) {
            let foundCountryId = null;
            let foundGroupIdx = null;

            Object.keys(countryData).forEach(cid => {
                const c = countryData[cid];
                if (c.groups) {
                    c.groups.forEach((g, idx) => {
                        if (g.name_tr && g.name_tr.toLowerCase() === name.toLowerCase()) {
                            foundCountryId = cid;
                            foundGroupIdx = idx;
                        }
                    });
                }
            });

            if (foundCountryId) {
                // Mevcut detay modalƒ±nƒ± kapat
                closeLongModal();
                // Yeni grubu a√ß
                openGroupModal(foundCountryId, foundGroupIdx);
            } else {
                alert("Bu grup veritabanƒ±nda bulunamadƒ±: " + name);
            }
        }

        function closeLongModal() {
            document.getElementById('long-detail-modal').classList.remove('active');
        }

        function closeAllModals() {
            document.getElementById('group-modal').classList.remove('active');
            document.getElementById('long-detail-modal').classList.remove('active');
        }

        function closeModal() {
            closeAllModals();
        }

        // Search
        document.getElementById('search-input').addEventListener('input', renderCountries);

        // Close modal on backdrop click
        document.getElementById('group-modal').addEventListener('click', function (e) {
            if (e.target === this) closeModal();
        });

        function printGroupReport() {
            const group = countryData[currentCountryId].groups[currentGroupIdx];
            const details = group.details || {};
            const status = group.grup_durumu || (details && details.grup_durumu) || "Bilinmiyor";
            const category = group.kategori || (details && details.kategori) || "Bilinmiyor";

            // Bulunduƒüu t√ºm √ºlkeleri bul
            let activeCountries = [];
            Object.values(countryData).forEach(c => {
                if (c.groups && c.groups.some(g => g.name_tr === group.name_tr)) {
                    activeCountries.push(c.name_tr);
                }
            });

            const printWindow = window.open('', '_blank');
            let html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Rapor: ${group.name_tr}</title>
                    <style>
                        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 40px; line-height: 1.6; color: #1e293b; background: #fff; }
                        .header { border-bottom: 4px solid #0f172a; padding-bottom: 20px; margin-bottom: 30px; display:flex; justify-content:space-between; align-items:flex-end; }
                        .header-left h1 { margin: 0; color: #0f172a; font-size: 28px; letter-spacing: -0.5px; }
                        .header-right { text-align: right; color: #64748b; font-size: 12px; }
                        
                        .main-meta { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px; }
                        .meta-box { background: #f8fafc; border: 1px solid #e2e8f0; padding: 20px; border-radius: 12px; }
                        .meta-label { font-size: 11px; text-transform: uppercase; color: #64748b; font-weight: 800; margin-bottom: 4px; letter-spacing: 0.5px; }
                        .meta-value { font-size: 16px; font-weight: 700; color: #0f172a; }

                        .section { margin-bottom: 35px; page-break-inside: avoid; }
                        .section-title { font-size: 14px; font-weight: 800; color: #0f172a; margin-bottom: 12px; border-bottom: 2px solid #e2e8f0; padding-bottom: 6px; text-transform: uppercase; display: flex; align-items: center; }
                        .section-title::before { content: ""; display: inline-block; width: 12px; height: 12px; background: #3b82f6; margin-right: 10px; border-radius: 2px; }
                        .content { padding: 0 5px; color: #334155; font-size: 14px; text-align: justify; }
                        
                        .no-print-btn { position: fixed; top: 20px; right: 20px; background: #0f172a; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight:bold; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); transition: all 0.2s; }
                        .no-print-btn:hover { background: #1e293b; transform: translateY(-1px); }
                        
                        @media print { .no-print-btn { display: none; } body { padding: 0; } .meta-box { border: 1px solid #ddd; } }
                    </style>
                </head>
                <body>
                    <button class="no-print-btn" onclick="window.print()">üñ®Ô∏è RAPORU YAZDIR / PDF KAYDET</button>
                    
                    <div class="header">
                        <div class="header-left">
                            <div style="font-size: 12px; font-weight: 800; color: #3b82f6; margin-bottom: 5px; text-transform: uppercase;">Militan Atlasƒ± Projesi | ƒ∞stihbarat Raporu</div>
                            <h1>${group.name_tr}</h1>
                        </div>
                        <div class="header-right">
                            <strong>Rapor ID:</strong> ${Math.random().toString(36).substr(2, 9).toUpperCase()}<br>
                            <strong>Tarih:</strong> ${new Date().toLocaleDateString('tr-TR')}
                        </div>
                    </div>

                    <div class="main-meta">
                        <div class="meta-box">
                            <div class="meta-label">√ñRG√úT KATEGORƒ∞Sƒ∞</div>
                            <div class="meta-value">${category}</div>
                        </div>
                        <div class="meta-box">
                            <div class="meta-label">MEVCUT DURUM</div>
                            <div class="meta-value">${status}</div>
                        </div>
                        <div class="meta-box" style="grid-column: span 2;">
                            <div class="meta-label">AKTƒ∞F OLDUƒûU B√ñLGELER / √úLKELER</div>
                            <div class="meta-value">${activeCountries.join(", ")}</div>
                        </div>
                    </div>
            `;

            const sections = [
                { title: 'Olu≈üumu ve Tarihsel Geli≈üimi', key: 'olusum_sureci' },
                { title: 'Ama√ß ve Nihai Hedefler', key: 'nihai_hedef' },
                { title: 'Y√∂netim Yapƒ±sƒ± ve Liderlik Kadrosu', key: 'yonetim_yapisi' },
                { title: 'Eylem Metotlarƒ± ve Taktiksel Yakla≈üƒ±mlar', key: 'eylem_metotlari' },
                { title: 'Kritik Eylemler ve Operasyonel Ge√ßmi≈ü', key: 'onemli_eylemler' },
                { title: 'Finansman Kaynaklarƒ± ve Lojistik Aƒülar', key: 'finansman_kaynaklari' },
                { title: 'Uluslararasƒ± ƒ∞li≈ükiler ve ƒ∞ttifaklar', key: 'grup_iliskileri' },
                { title: 'Stratejik Analiz ve Diƒüer Veriler', key: 'diger_bilgiler' },
                { title: 'Kaynak√ßa ve Veri Doƒürulama', key: 'kaynakca' }
            ];

            sections.forEach(s => {
                const val = details[s.key];
                if (val && val.trim() !== "" && val !== "...") {
                    // HTML taglerini temizlemeden veya koruyarak i√ßeriƒüi ekle
                    html += `
                        <div class="section">
                            <div class="section-title">${s.title}</div>
                            <div class="content">${val}</div>
                        </div>
                    `;
                }
            });

            html += `
                    <div style="margin-top:60px; text-align:center; font-size:11px; color:#94a3b8; border-top:1px solid #e2e8f0; padding-top:20px; font-style: italic;">
                        Bu rapor Militan Atlasƒ± dijital veritabanƒ±ndan otomatik olarak olu≈üturulmu≈ütur. <br>
                        ¬© ${new Date().getFullYear()} Militan Atlasƒ± Projesi. T√ºm haklarƒ± saklƒ±dƒ±r.
                    </div>
                </body>
                </html>
            `;

            printWindow.document.write(html);
            printWindow.document.close();
        }

        // Load on page load
        loadData();
    </script>
</body>

</html>
